package com.fmsh.einkesl.tools;

import android.nfc.Tag;
import android.nfc.tech.IsoDep;
import android.os.Bundle;
import android.util.Log;

import com.bumptech.glide.util.Util;
import com.fmsh.base.utils.ActivityUtils;
import com.fmsh.base.utils.BroadcastManager;
import com.fmsh.base.utils.Constant;
import com.fmsh.base.utils.FMUtil;
import com.fmsh.base.utils.HintDialog;
import com.fmsh.base.utils.LogUtil;
import com.fmsh.base.utils.NfcConstant;
import com.fmsh.base.utils.UIUtils;
import com.fmsh.compress.CompressUtils;
import com.fmsh.einkesl.App;
import com.fmsh.einkesl.R;
import com.fmsh.einkesl.bean.DeviceInfo;
import com.fmsh.einkesl.tools.image.BmpUtils;
import com.fmsh.einkesl.tools.image.ImageUtils;
import com.fmsh.einkesl.utils.EncryUtils;
import com.fmsh.einkesl.utils.IUtils;

import java.io.IOException;
import java.util.ArrayList;

/**
 * @author wuyajiang
 * @date 2020/5/20
 * 1443-4芯片
 */
public class IsoDepUtils {
    private static String mBmpPath;

    /**
     * 判断是否包含1443-4
     *
     * @param tag
     * @return
     */
    public static boolean isContains(Tag tag) {
        IsoDep isoDep = IsoDep.get(tag);
        if (isoDep == null) {
            return false;
        }
        return true;
    }

    /**
     * 获取AST
     *
     * @param tag
     * @return
     */
    public static byte[] getATS(Tag tag) {
        IsoDep isoDep = IsoDep.get(tag);
        byte[] ast = new byte[2];
        if (isoDep != null) {
            ast = isoDep.getHistoricalBytes();
        }
        return ast;
    }

    public static void startIsoDep(Bundle bundle) {
        Tag tag = bundle.getParcelable(NfcConstant.KEY_TAG);
        if (tag == null) {
            return;
        }
        IsoDep isoDep = IsoDep.get(tag);
        if (isoDep != null) {
            try {
                isoDep.setTimeout(50000);
                if (!isoDep.isConnected()) {
                    isoDep.connect();
                }
                byte[] transceive = isoDep.transceive(FMUtil.hexToByte("00A4040007D2760000850101"));
                LogUtil.d(FMUtil.byteToHex(transceive));
                LogUtil.d("start", System.currentTimeMillis());
                switch (bundle.getInt("position")) {
                    case 0:
                        getDeviceInfo(isoDep);
                        break;
                    case 1:
                        if (App.getDeviceInfo().getPin()) {
                            if (verifyPinCode(isoDep, bundle.getString("pin"))) {
                                mBmpPath = bundle.getString("path");
                                handlerImage(isoDep, bundle.getBoolean("isLvl"));
                            }
                        } else {
                            mBmpPath = bundle.getString("path");
                            handlerImage(isoDep, bundle.getBoolean("isLvl"));
                        }
                        break;
                    case 2:
                        if (bundle.getBoolean("isPin")) {
                            if (verifyPinCode(isoDep, bundle.getString("pin"))) {
                                sendApdu(isoDep, bundle.getString("apdu"));
                            }
                        } else {
                            sendApdu(isoDep, bundle.getString("apdu"));
                        }
                        break;
                    case 3:
                        updatePin(isoDep, bundle.getString("oldPin"), bundle.getString("pin"));
                        break;
                    default:
                        break;
                }
            } catch (Exception e) {
                e.printStackTrace();
                UIUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error), -1, App.getHandler());
            } finally {
                try {
                    isoDep.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }

            }
        }
    }

    private static void sendApdu(IsoDep isoDep, String apdu) throws IOException {
        // String[] mApdu = apdu.split(",");

        ArrayList<String> mApdu = new ArrayList<>();
        mApdu.add("F0D80000050000000064");
        mApdu.add("F0DB020000");
        mApdu.add("F0DB000099A006072001E001A0A4010CA502000AA40108A502000AA4010CA502000AA40103A10300CF29A10701070022780A22A10403105444A10406C0C0C0A1023002A1024100A1025037A103600303A1056100F001A0A1056500000000A102E73CA102E300A102E000A102FFA5A107EF010A080A0D0AA102FFE3A102E901A10104A40103A30110A2021210A40103A2020200A40103A20207A5A502000A");
        mApdu.add("F0DA000003F00720");
        mApdu.add("F0DA000103120030");
        mApdu.add("F0D20000FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D20001FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D20002FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D20003FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D20004FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D20005FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF55FD555555FFFF557FFFFFD55FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D20006FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF55FD555555FFFF555FFFFFD557FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF55FD555555FFFF555FFFFFD557FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF55FFFF55FFFFFD555FFFFF5557FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF55FFFF55FFFFFD555FFFFF5557FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D20007FAFFFFFFFFFFFFFFFFFFFFFFFFFFFF55FFFF55FFFFFD5557FFFF5555FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF55FFFF55FFFFFD5D57FFFF5755FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF55FFFF55FFFFF55D57FFFD5755FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF55555FFFF55FFFFF55D57FFFD5755FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D20008FAFFFF555555FFFF55FFFFF55F55FFFD57D57FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD555555FFFF55FFFFF57F55FFFD5FD57FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5555555FFFF55FFFFD57F55FFF55FD57FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD557FF55FFFF55FFFFD57F55FFF55FD57FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD55FFF55FFFF55FFFF");
        mApdu.add("F0D20009FAD57FD57FF55FF55FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD55FFF55FFFF55FFFFD5FFD57FF57FF55FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD57FFF55FFFF55FFFF55FFD57FD57FF55FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD57FFF55FFFF55FFFF55FFD57FD57FF55FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD55FFF55FFFF55FFFF55FFF55FD57FFD57FFFF");
        mApdu.add("F0D2000AFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD55FFF55FFFF55FFFF55FFF55FD57FFD57FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5555555FD555555FD57FFF55F55FFFD57FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5555555FD555555FD57FFF55F55FFFD57FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD555555FD555555FD57FFF55755FFFD57FFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D2000BFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFD55555FD555555FD57FFFD5755FFFF57FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D2000CFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D2000DFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D2000EFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        mApdu.add("F0D2000FFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
//        mApdu.add("F0D20010FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20011FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555400155401401400000015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555400155401401400000015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554014140155541415555415555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20012FA55555555555555555555555555555555555555555555555555401414015554141555541555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554155415541401541400141555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554155415541401541400141555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554000155554154141400141555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20013FA55555555555555555555555555555400015555415414140014155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555400140015415554140014155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555400140015415554140014155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555400140001554155554155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20014FA55555555555540014000155415555415555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555541401414154001400000015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555541401414154001400000015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555540015541541555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555540015541");
//        mApdu.add("F0D20015FA54155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554015414141541541400141555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554015414141541541400141555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554001415401415555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554001415401415555555555");
//        mApdu.add("F0D20016FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555541415540155400141401555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555541415540155400141401555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555415555415554015555414155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555415555415554015555414155555555555555555555555555555");
//        mApdu.add("F0D20017FA55555555555555555555555555555555555555555555555555555555555555555555554014001554014015414015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554014001554014015414015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555400001555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555400001555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20018FA55555555555555555555555555555555555555555555555554000000141414140000001555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554000000141414140000001555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554155554140154141555541555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554155554140154141555541555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20019FA55555555555555555555555555555414001414155414140014155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555414001414155414140014155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555414001415414154140014155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555414001415414154140014155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2001AFA55555555541400141415401414001415555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555541400141415401414001415555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555541555541541401415555415555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555541555541541401415555415555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555540000001401");
//        mApdu.add("F0D2001BFA41540000001555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554000000140141540000001555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2001CFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2001DFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2001EFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2001FFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20020FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20021FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20022FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20023FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20024FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555550000000000000000000000000000000000000000000000000001555555555555555555555555555555555555555555555555555555555555555555550000000000000000000000000000000000000000000000000001555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20025FA5555555555555500000000000000000000000000000000000000000000000000015555555555555555555555555555555555555555555555555555555555555555555500000000000000000000000000000000000000000000000000015555555555555555555555555555555555555555555555555555555555555555555500000000000000000000000000000000000000000000000000015555555555555555555555555555555555555555555555555555555555555555555500000000002000000000000000000000000000000800000000015555555555555555555555555555555555555555555555555555555555555555555500002A");
//        mApdu.add("F0D20026FA002AAA8002A002A80AAA000000002A00AAAAA0000000A95555555555555555555555555555555555555555555555555555555555555555555500002A00AAAAA002A002A80AAA800000002A00AAAAA8000000A95555555555555555555555555555555555555555555555555555555555555555555500002A00AAAAA802A002A80AAAA00000002A00AAAAAA000000A95555555555555555555555555555555555555555555555555555555555555555555500002A00A000AA02A002A80002A00000002A00AA00AA000000A95555555555555555555555555555555555555555555555555555555555555555555500002A000000AA02A002A80002");
//        mApdu.add("F0D20027FAA00000002A00AA002A000000A95555555555555555555555555555555555555555555555555555555555555555555500002A0000002A02A002A80002A00000002A00A8002A000000A95555555555555555555555555555555555555555555555555555555555555555555500002A0000002A02A002A80002A00000002A00A800AA000000A95555555555555555555555555555555555555555555555555555555555555555555500002A02AAAAAA02A002A80002A00000002A00AAAAA8000000A95555555555555555555555555555555555555555555555555555555555555555555500002A02AAAAAA02A002A80002A00000002A00AAAAA800");
//        mApdu.add("F0D20028FA0AAAA95555555555555555555555555555555555555555555555555555555555555555555500002A02AAAAAA02A002A80002A00000002A00AAAA8000AAAAA9555555555555555555555555555555555555555555555555555555555555555555550000AA02A8002A02A002A80002A0000000AA00A8000002AAAAA9555555555555555555555555555555555555555555555555555555555555555555552000AA00A800AA02A802A80002A0002000AA00A8000802AA00A9555555555555555555555555555555555555555555555555555555555555555555552A0AAA00AA02A802A80AA80002A0002A0AAA00AA00A80AA800A955555555555555");
//        mApdu.add("F0D20029FA5555555555555555555555555555555555555555555555555555552AAAAA002AAAA800AAAAA80AAAAAA02AAAAA00AAAAA80AA000A9555555555555555555555555555555555555555555555555555555555555555555552AAAAA002AAAA000AAA8A80AAAAAA02AAAAA002AAAA80AA000A9555555555555555555555555555555555555555555555555555555555555555555550AA82A0002AA00002AA2A80AAAAAA00AA82A0002AAA00AA000A95555555555555555555555555555555555555555555555555555555555555555555500000000000000000000000002A0000000000000000002A800A95555555555555555555555555555555555");
//        mApdu.add("F0D2002AFA555555555555555555555555555555555500000000000000000000000002A0000000000000000002AAAAA95555555555555555555555555555555555555555555555555555555555555555555500000000000000000000000002A0000000000000000000AAAAA95555555555555555555555555555555555555555555555555555555555555555555500000000000000000000000002A00000000000000000002AAAA955555555555555555555555555555555555555555555555555555555555555555555000000000000000000000000000000000000000000000000AAA9555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2002BFA55555555555555000000000000000000000000000000000000000000000000000155555555555555555555555555555555555555555555555555555555555555555555000000000000000000000000000000000000000000000000000155555555555555555555555555555555555555555555555555555555555555555555000000000000000000000000000000000000000000000000000155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2002CFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2002DFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2002EFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2002FFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20030FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20031FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20032FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20033FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20034FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555400555405540550000554015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555000155405540540000550005555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555000055405540540000540001555555555555555555555555555");
//        mApdu.add("F0D20035FA55555555555555555555555555555555555555555555555555555555555555555555405405540554054054054050155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555405405540554054054054050155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555405405540554054054054050155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555405405540554054054054050155555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20036FA55555555555555555555555555555555555555555555555540540554055405405405405015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555540554055405400005405015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555540554055405540005405015555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555540540554055405400005405015555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20037FA55555555555555555555555555554054055405540540540540501555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554054055405540540540540501555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554054055405540540540540501555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554000050000140540000540501555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20038FA55555555500015000014055000054050155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555540055000014055400054050155555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20039FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2003AFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2003BFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2003CFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2003DFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2003EFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2003FFA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555005401540100555401540100555400015555401405550050050055540155540154010055005401500550040150015500555555555555555555555555005401540000155401540000154000005555400001540000054015500555540154000");
//        mApdu.add("F0D20040FA01500540150055000005400550055555555555555555555555500540154005005540154005005001540555540050054014005401550055554015400500500540150055001401500150055555555555555555555555500540154015005540154015005005554555540150050055005400000055554015401500500540150055005401540050055555555555555555555555500540154015005540154015005005555555540150050055005500000155554015401500500540150055005401550010055555555555555555555555500540154000015540154000015001555555540150050055005500540155554015400001500540150055000005");
//        mApdu.add("F0D20041FA55400005555555555555555555555550054015400005554015400005500001555554015005005500550054015555401540000550054015005500001555500005555555555555555555555550054015401555554015401555540000155554015005005500554054055555401540155550054015005500555555540005555555555555555555555550050015401551550015401551554000055554015005401400554010055555401540155150050014005500554555540005555555555555555555555554000015500001400015500001555540055554015005400000554010055555401550000154001000005540000555500005555555555555");
//        mApdu.add("F0D20042FA55555555555501401554000540401554000555555005555401500550050055501015555540155400055500540100555000155540100555555555555555555555555555401555555555555555555554555005555555555555550055500015555540155555555555555555555555555500500555555555555555555555555555401555555555555555555554154005555555555555550055500015555540155555555555555555555555555401500555555555555555555555555555401555555555555555555554000015555555555555550055540055555540155555555555555555555555555005500555555555555555555555555555401555");
//        mApdu.add("F0D20043FA55555555555555555400015555555555555555005554005555554015555555555555555555555555401550055555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20044FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20045FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20046FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20047FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20048FA55555555555555555555555555555555555550000000000000000000000000000000000000000005555555555555555555555555555555555555555555555555555555555555555555555555555552AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD555555555555555555555555555555555555555555555555555555555555555555555555555552AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD555555555555555555555555555555555555555555555555555555555555555555555555555552AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20049FA555555555555555552AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA955555555555555555555555555555555555555555555555555555555555555555555555555554AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA955555555555555555555555555555555555555555555555555555555555555555555555555554AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA955555555555555555555555555555555555555555555555555555555555555555555555555555EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA955555555555555555555555555555555555555555555555555555555555555555555555555555AAA");
//        mApdu.add("F0D2004AFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA95555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2004BFA5555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555556EBFAFABEBEAFAFABEBFAFAFEBEAFAFABEBEAFAFFAAE55555555555555555555555555555555555555555555555555555555555555555555555555556AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA55555555555555555555555555555555555555555555555555555555555555555555555555552AAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAA");
//        mApdu.add("F0D2004CFA95555555555555555555555555555555555555555555555555555555555555555555555555552AAAAE5EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAE5EAAAAD5555555555555555555555555555555555555555555555555555555555555555555555555542AAB5555AAAAAD5AAAAAAD5EAAAAA95EAAAAD5556AAA9555555555555555555555555555555555555555555555555555555555555555555555555554AAA555555AAAA556AAAAD555BAAAA552AAAD555552AAA555555555555555555555555555555555555555555555555555555555555555555555555554AAAC555550AAA554AAA955555AAAB552AA85555502AAB5555555555555555555");
//        mApdu.add("F0D2004DFA55555555555555555555555555555555555555555555555555555556AAAA81500AAAA550AAA0555502AAB552AAA80540AAAAA555555555555555555555555555555555555555555555555555555555555555555555555552AAAAA802AAAAA152AAAA05502AAAA542AAAAA00AAAAAA555555555555555555555555555555555555555555555555555555555555555555555555542AAAAAAAAAAAAAA0AAAAAA80AAAAAAA2AAAAAAAAAAAAAAD5555555555555555555555555555555555555555555555555555555555555555555555550AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB55555555555555555555555555555555555555");
//        mApdu.add("F0D2004EFA55555555555555555555555555555555552AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA555555555555555555555555555555555555555555555555555555555555555555555554AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA955555555555555555555555555555555555555555555555555555555555555555555550AABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABFAA5555555555555555555555555555555555555555555555555555555555555555555550AA955AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAD55AA855555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2004FFA5555555555402AA9557AAE56AAAAAAAAAAAAAAAAAAAAAAAAAAAAB55FAB554AAA8155555555555555555555555555555555555555555555555555555555555555553AAAAB554AD5557AAE55EAAAAAAAAAAAAAAAD55EAB555579550AAAAA5555555555555555555555555555555555555555555555555555555555555555EAAAAA955F55555AB5556AAAAAAAAAAAAAAB5557A955555D542AAAAA95555555555555555555555555555555555555555555555555555555555555552AAAAA955555000E955556AD55EAAAD55BA95554A800555554AAAAAA95555555555555555555555555555555555555555555555555555555555554052AAAAAA555");
//        mApdu.add("F0D20050FA552AAA81555795556AAB5555E55540AAAA955556AAAAAA90055555555555555555555555555555555555555555555555555555555542A82AAEAB955555EAAAAA555555555AAD555555550AAAAAD555555FFAAA82AD555555555555555555555555555555555555555555555555555555554AAAAAA555555555AAAAAAD555555552A9555555542AAAAA9555555552AAAAAB555555555555555555555555555555555555555555555555555555554AAAAAA5555555557AAAAAA555555402A015555555AAAAAA5555555552AAAAAA555555555555555555555555555555555555555555555555555555557AAAAAAD555555555AAAAAD5555543AAAA");
//        mApdu.add("F0D20051FAA15555557AAAAD555555554AAAAAAA555555555555555555555555555555555555555555555555555555544AAAAAA95555555552AAAE5555554AAAAAA95555555EAAA5555555550AAAAAAA15555555555555555555555555555555555555555555555555555542AAAAAAAA555555550AAA555555555EAAAAA9555555557AAB555555552AAAAAAAA155555555555555555555555555555555555555555555555555550AAAAAAAAA955555542AAB5555555557AAAAA9555555552AAA05555555EAAAAAAAAA55555555555555555555555555555555555555555555555555552AAAAAAAAAE5555502AAAAD5555555557AAAD5555555542AAAA05555");
//        mApdu.add("F0D20052FA55AAAAAAAAAA55555555555555555555555555555555555555555555555555552AAAAAAAAB5555503AAAAA95555555555AA95555555554AAAAAAD555555AAAAAAAAA95555555555555555555555555555555555555555555555555552AAAAAAAA9555556AAAAAAB55555555542A55555555552AAAAAAB5555556AAAAAAAA95555555555555555555555555555555555555555555555555556AAAAAAAA5555554AAAAAAAD555555550AAB5555555542AAAAAAB5555555EAAAAAAA55555555555555555555555555555555555555555555555555554AAAAAAAD5555554AAAAAAAB555555542AAAD55555550AAAAAAAB55555556AAAAAAA55555555");
//        mApdu.add("F0D20053FA555555555555555555555555555555555555555555543AAAAAAA55555554AAAAAAAA95555540AAAAA15555556AAAAAAAB55555557AAAAAAA1555555555555555555555555555555555555555555555555554AAAAAAAA55555554AAAAAAAA9555540AAAAAA85555557AAAAAAAB55555555AAAAAAA9555555555555555555555555555555555555555555555555553AAAAAAAD55555554AAAAAAAD555554AAAAAAAA9555555AAAAAAAB555555552AAAAAAA555555555555555555555555555555555555555555555555556AAAAAAA955555554AAAAAAB5555557AAAAAAAAB5555557AAAAAAB555555556AAAAAAA955555555555555555555555555");
//        mApdu.add("F0D20054FA555555555555555555555557AAAAAAA555555552AAAAAA95555555EAAAAAAA95555555EAAAAAA555555556AAAAAAA955555555555555555555555555555555555555555555555555AAAAAAB555555552AAAAAAD55555552AAAAAAAD55555556AAAAAA955555556AAAAAAB555555555555555555555555555555555555555555555555555AAAAAAB555555552AAAAAB555555556AAAAAAA955555557AAAAAA955555556AAAAAAD5555555555555555555555555555555555555555555555555550AAAAAB55555554EAAAAA9555555556AAAAAAB555555555AAAAAAD55555556AAAAAA555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20055FA5554AAAAAAB55555554AAAAAA9555555556AAAAAAA555555555EAAAAA955555556AAAAAAD555555555555555555555555555555555555555555555555554AAAAAAB55555554AAAAAA9555555554AAAAAA95555555556AAAAAA55555552AAAAAAB555555555555555555555555555555555555555555555555554AAAAAAA55555552AAAAAB5555555554AAAAAA95555555556AAAAAB55555552AAAAAAA555555555555555555555555555555555555555555555555554AAAAAAA95555552AAAAA95555555554AAAAAA95555555554AAAAAA95555552AAAAAAA555555555555555555555555555555555555555555555555555AAAAAAAD5555542A");
//        mApdu.add("F0D20056FAAAAA95555555554AAAAAA95555555555AAAAAAD5555542AAAAAAB555555555555555555555555555555555555555555555555555EAAAAAAA555554AAAAAAD5555555555AAAAAA955555555552AAAAA9555554AAAAAAAD5555555555555555555555555555555555555555555555555555AAAAAAB555554AAAAAAD5555555554AAAAAA955555555552AAAAAA555550AAAAAAE555555555555555555555555555555555555555555555555555550AAAAAA555556AAAAAA95555555554AAAAAA955555555552AAAAAB555552AAAAAA5555555555555555555555555555555555555555555555555555552AAAAAA955552AAAAAA55555555554AAAAA");
//        mApdu.add("F0D20057FAA955555555556AAAAAB55550AAAAAAA955555555555555555555555555555555555555555555555555555EAAAAAAA55556AAAAAA55555555554AAAAAA955555555556AAAAAA55542AAAAAAAD555555555555555555555555555555555555555555555555555552AAAAAAA85556AAAAAA55555555554AAAAAA955555555556AAAAAA5540AAAAAAAA9555555555555555555555555555555555555555555555555555557AAAAAAAA8156AAAAAA55555555554AAAAAA955555555552AAAAAA540AAAAAAAAA5555555555555555555555555555555555555555555555555555555EAAAAAAAAA02AAAAAA55555555554AAAAAA955555555552AAAAAA0");
//        mApdu.add("F0D20058FAEAAAAAAAAFE555555555555555555555555555555555555555555555555555555554AAAAAAAAAAAAAAAA95555555554AAAAAAA55555555552AAAAAAAAAAAAAAAB55555555555555555555555555555555555555555555555555555555554AAAAAAAAAAAAAAAA95555555556AAAAAAA55555555552AAAAAAAAAAAAAAAB55555555555555555555555555555555555555555555555555555555554AAAAAAAAAAAAAAAAD5555555552AAAAAAB55555555542AAAAAAAAAAAAAAAB55555555555555555555555555555555555555555555555555555555555EAAAAAAAAAAAAAAA95555555552AAAAAAA5555555554AAAAAAAAAAAAAAAAB55555555555");
//        mApdu.add("F0D20059FA5555555555555555555555555555555555555555555555557AFAAAAAAAAAAAAAA5555555542AAAAAAAD555555554AAAAAAAAAAAAAB7B955555555555555555555555555555555555555555555555555555555555554AAAAAAAAAAAAAB555555554AAAAAAAA9555555552AAAAAAAAAAAAAB55555555555555555555555555555555555555555555555555555555555555555EAAAAAAAAAAAAA955555553AAAAAAAAA55555554EAAAAAAAAAABAA9555555555555555555555555555555555555555555555555555555555555555557AEEAAAAAAAAAAB55555552AAAA6AAAB55555550AAAAAAAAAAADEB95555555555555555555555555555555555");
//        mApdu.add("F0D2005AFA55555555555555555555555555555555557AAEAAAAAAAA9555554EAAAB5AAAAD5555542AAAAAAAB7AA5555555555555555555555555555555555555555555555555555555555555555555555555BD7AAAAAAAAB555550AAAA95EAAAB555540AAAAAAAAB5BD5555555555555555555555555555555555555555555555555555555555555555555555555554AAAAAAAAA855552AAAA957AAAA555502AAAAAAAAA5555555555555555555555555555555555555555555555555555555555555555555555555555555EAAAAAAAAA8150AAAAB555AAAA85402AAAAAAAAA95555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2005BFA5555555555555555556AAAAAAAAAA802AAAA9555AAAAA00EAAAAAAAAAAD5555555555555555555555555555555555555555555555555555555555555555555555555555555552AAAAAAAAAAAAAAA54957AAAAAAAAAAAAAAAD55555555555555555555555555555555555555555555555555555555555555555555555555555555555EAAAAAAAAAAAAAAB50B55EAAAAAAAAAAAAAA9555555555555555555555555555555555555555555555555555555555555555555555555555555555556AAAAAAAAAAAAAA942A557AAAAAAAAAAAAAAD55555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D2005CFA7AAAAAAAAAAAAA954AA955EAAAAAAAAAAAAA9555555555555555555555555555555555555555555555555555555555555555555555555555555555555EBAAAAAAAAAAA950AAA557AAAAAAAAAA7AB5555555555555555555555555555555555555555555555555555555555555555555555555555555555555556AAAAAAAAB950AAAA8557AAAAAAAAA5555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555FE55ABFA9542AAAAA1556FFE955BF555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555552AAAAA");
//        mApdu.add("F0D2005DFAAA5555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555556EAAAAAAAE55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555AAAA955555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555552AAA95555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555550AAAA85555555555555555555");
//        mApdu.add("F0D2005EFA555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555550AAAAA5555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555556AAAAA9555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554AAAAB5555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555AAAAA555555555555555555555555555555555555555");
//        mApdu.add("F0D2005FFA5555555555555555555555555555555555555555555555555555555555555555555555555555EAAA955555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555552AAAD55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555557AAA555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555554AAB555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20060FA555555555555555555555555555555555555555555555555555555555AA9555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555EAD5555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555552A55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555557A555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20061FA55555555555555555555555555555555555554B55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555D55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555D55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20062FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555");
//        mApdu.add("F0D20063FA55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000");
        mApdu.add("F0D4058000");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");
//        mApdu.add("F0DE000001");

        if (mApdu.size() > 0) {
            IUtils.sendMessage("", 2);
        }
        for (int i = 0; i < mApdu.size(); i++) {
            IUtils.sendMessage(">>:" + mApdu.get(i) + "\r\n", 1);
            byte[] bytes = isoDep.transceive(FMUtil.hexToByte(mApdu.get(i)));
            IUtils.sendMessage("<<:" + FMUtil.byteToHex(bytes) + "\r\n", 1);
        }
    }

    private static void handlerImage(IsoDep isoDep, boolean isLvl) throws IOException {
        byte[] result = isoDep.transceive(FMUtil.hexToByte("00D1000000"));
        byte[] result2 = isoDep.transceive(FMUtil.hexToByte("F0D8000005000000000E"));
        DeviceInfo deviceInfo = IUtils.loadDeviceInfo(ActivityUtils.instance.getCurrentActivity(), FMUtil.byteToHex(result) + FMUtil.byteToHex(result2));
        //  DeviceInfo deviceInfo = App.getDeviceInfo();
        boolean bmpFormat = BmpUtils.GetBmpFormat(mBmpPath, deviceInfo);
        if (bmpFormat) {
            int color_cnt = App.getDeviceInfo().getColorCount();
            if (color_cnt == 2) {
                writeBlackWhiteScreen(isoDep);
            } else if (color_cnt == 3) {
                write3ColorScreen(isoDep, isLvl);
            } else {
                if ((color_cnt == 4) && (null != App.getDeviceInfo().getColorDesc())) {
                    write4ColorScreen(isoDep, isLvl);
                } else {
                    writeMulColorScreen(isoDep, isLvl);
                }
            }
        } else {
            UIUtils.sendMessage(UIUtils.getString(R.string.bmp_error), -1, App.getHandler());
        }
    }

    /**
     * 黑白图片刷屏
     *
     * @param isoDep
     */
    private static void writeBlackWhiteScreen(IsoDep isoDep) {
        byte[] bmpdata = ImageUtils.ReadBmp8File(mBmpPath);
        if (bmpdata == null) {
            UIUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error), -1, App.getHandler());
            return;
        }
        LogUtil.d(FMUtil.byteToHex(bmpdata));

        int destRealWidth = (int) Math.ceil(App.getDeviceInfo().getWidth() / 8.0);
        int destWidth = 0;
        int percent = destRealWidth % 4;
        if (percent != 0) {
            destWidth += destRealWidth - percent + 4;
        } else {
            destWidth = destRealWidth;
        }
        int vbitsRow = (int) Math.ceil(App.getDeviceInfo().getHeight() / 8.0);

        byte[] result = new byte[bmpdata.length];
        if (App.getDeviceInfo().getRefreshScan() == 0) {
            ImageUtils.VerticalScanning(result, bmpdata, destRealWidth, vbitsRow, destWidth);

            LogUtil.d("转换", System.currentTimeMillis());
        } else {
            //            byte[] src = new byte[bmpdata.length-0x3E];
            //            System.arraycopy(bmpdata,0x3E,src,0,src.length);
            result = ImageUtils.HorizontalScanning(bmpdata, destRealWidth, App.getDeviceInfo().getHeight(), destWidth);
        }
        // 行数等于总的字节数 / 每次发送的字节数250 / 8 向上取整
        int rowCount = (int) Math.ceil(App.getDeviceInfo().getWidth() * App.getDeviceInfo().getHeight() / 250 / 8.0);
        if (!WriteBmpdataEx(isoDep, result, rowCount, 0)) {
            return;
        }
        RefreshScreenAfterWriteBmpdataex(isoDep, 0);
    }

    private static void write4ColorScreen(IsoDep isoDep, boolean isLvl) {
        byte[] bmpdata = ImageUtils.ReadBmp24File(mBmpPath, isLvl);
        if (bmpdata == null) {
            UIUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error), -1, App.getHandler());
            return;
        }
        int width = App.getDeviceInfo().getWidth();
        int height = App.getDeviceInfo().getHeight();
        byte[] data1 = new byte[width * height];
        byte[] data2 = new byte[width * height];
        ImageUtils.getColorDataBmp4(bmpdata, data1);

        byte[] result = null;
        byte[] result1 = null;
        String ColorDesc = App.getDeviceInfo().getColorDesc();
        if (null == ColorDesc) {
            if (App.getDeviceInfo().getRefreshScan() == 0) {
                result = ImageUtils.Color24VerticalScanning(data1);
                result1 = ImageUtils.Color24VerticalScanning(data2);
            } else {
                result = ImageUtils.color24horizontalScanning(data1);
                result1 = ImageUtils.color24horizontalScanning(data2);
            }
        } else if (App.getDeviceInfo().getColor().contentEquals("黑白红黄四色")) {
            if (App.getDeviceInfo().getRefreshScan() == 0) {
                result = ImageUtils.Color4VerticalScanning(data1);
            } else {
                result = ImageUtils.color4horizontalScanning(data1);
            }
        }
        // 行数等于总的字节数 / 每次发送的字节数250 / 8 向上取整
        int rowCount = (int) Math.ceil(width * height / 250 / 8.0);

        if (null == ColorDesc) {
            if (App.getDeviceInfo().getSize() == 1) {
                if (!WriteBmpdataEx(isoDep, result, rowCount, 0)) {
                    return;
                }

            } else if (App.getDeviceInfo().getSize() == 2) {
                if (!WriteBmpdataEx(isoDep, result, rowCount, 0)) {
                    return;
                }
                if (!WriteBmpdataEx(isoDep, result1, rowCount, 1)) {
                    return;
                }

            }
        } else if (App.getDeviceInfo().getColor().contentEquals("黑白红黄四色")) {
            if (!WriteBmpdataEx(isoDep, result, rowCount * 2, 0)) {
                return;
            }
        }
        RefreshScreenAfterWriteBmpdataex(isoDep, 0);
    }

    private static void write3ColorScreen(IsoDep isoDep, boolean isLvl) {
        byte[] bmpdata = ImageUtils.ReadBmp24File(mBmpPath, isLvl);
        if (bmpdata == null) {
            UIUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error), -1, App.getHandler());
            return;
        }
        int width = App.getDeviceInfo().getWidth();
        int height = App.getDeviceInfo().getHeight();
        byte[] data1 = new byte[width * height];
        byte[] data2 = new byte[width * height];
        ImageUtils.getColorDataBmp24(bmpdata, data1, data2);

        byte[] result = null;
        byte[] result1 = null;
        if (App.getDeviceInfo().getRefreshScan() == 0) {
            result = ImageUtils.Color24VerticalScanning(data1);
            result1 = ImageUtils.Color24VerticalScanning(data2);
        } else {
            result = ImageUtils.color24horizontalScanning(data1);
            result1 = ImageUtils.color24horizontalScanning(data2);
        }
        // 行数等于总的字节数 / 每次发送的字节数250 / 8 向上取整
        int rowCount = (int) Math.ceil(width * height / 250 / 8.0);


        if (App.getDeviceInfo().getSize() == 1) {
            if (!WriteBmpdataEx(isoDep, result, rowCount, 0)) {
                return;
            }

        } else if (App.getDeviceInfo().getSize() == 2) {
            if (!WriteBmpdataEx(isoDep, result, rowCount, 0)) {
                return;
            }
            if (!WriteBmpdataEx(isoDep, result1, rowCount, 1)) {
                return;
            }

        }
        RefreshScreenAfterWriteBmpdataex(isoDep, 0);

    }

    private static void writeMulColorScreen(IsoDep isoDep, boolean isLvl) {
        byte[] bmpdata = ImageUtils.ReadBmp24File(mBmpPath, isLvl);
        if (bmpdata == null) {
            UIUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error), -1, App.getHandler());
            return;
        }
        int width = App.getDeviceInfo().getWidth();
        int height = App.getDeviceInfo().getHeight();
        int pic_num = App.getDeviceInfo().getSize();
        byte[][] data = new byte[pic_num][width * height];
        ImageUtils.getColorDataBmp24(bmpdata, data);

        byte[][] result = new byte[pic_num][];
        if (App.getDeviceInfo().getRefreshScan() == 0) {
            UIUtils.sendMessage("当前屏幕不支持垂直扫描模式", -1, App.getHandler());
            return;
        } else {
            for (int i = 0; i < pic_num; i++) {
                result[i] = ImageUtils.multicolor24horizontalScanning(data[i]);
            }
        }
        // 行数等于总的字节数 / 每次发送的字节数250 / 8 向上取整
        int rowCount = (int) Math.ceil(width * height / 250 / 8.0);


        if (App.getDeviceInfo().getSize() == 1) {
            if (!WriteBmpdataEx(isoDep, result[0], rowCount, 0)) {
                return;
            }

        } else if (App.getDeviceInfo().getSize() == 2) {
            if (!WriteBmpdataEx(isoDep, result[0], rowCount, 0)) {
                return;
            }
            if (!WriteBmpdataEx(isoDep, result[1], rowCount, 1)) {
                return;
            }
        } else {
            for (int i = 0; i < pic_num; i++) {
                if (!WriteBmpdataEx(isoDep, result[i], rowCount, i)) {
                    return;
                }
            }
        }
        RefreshScreenAfterWriteBmpdataex(isoDep, 0);
    }

    /**
     * @param result
     * @param rowCount
     * @return
     */
    private static boolean WriteBmpdataEx(IsoDep isoDep, byte[] result, int rowCount, int ScreenIndex) {
        boolean isCompress = App.getDeviceInfo().isCompress();
        //boolean isCompress =false;
        int m_bmpWidth = App.getDeviceInfo().getWidth();
        int m_bmpHeight = App.getDeviceInfo().getHeight();
        int size = 0;
        if (isCompress) {
            try {
                //LogUtil.d("压缩", System.currentTimeMillis());
                //LogUtil.d(FMUtil.byteToHex(result));
                int p = m_bmpHeight % 8;
                if (p != 0) {
                    m_bmpHeight = (8 - p) + m_bmpHeight;
                }
                String ColorDesc = App.getDeviceInfo().getColorDesc();
                if (null == ColorDesc) {
                    size = m_bmpWidth * m_bmpHeight / 8;
                } else if (App.getDeviceInfo().getColor().contentEquals("黑白红黄四色")) {
                    size = m_bmpWidth * m_bmpHeight / 4;
                }
//                                if(App.getDeviceInfo().getColorCount() == 2){
//                                   int width =  (int) Math.ceil(m_bmpWidth / 8.0);
//                                     size = width * m_bmpHeight /8;
//                                }
                byte[] bytes = new byte[size];
                System.arraycopy(result, 0, bytes, 0, bytes.length);
                result = bytes;
                //LogUtil.d(FMUtil.byteToHex(result));
                String compress = CompressUtils.compress(isoDep, result, ScreenIndex);
                LogUtil.d("压缩完成", System.currentTimeMillis());
                if ("9000".equals(compress)) {
                    return true;
                } else {
                    UIUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_compress_error) + compress, -1, App.getHandler());
                    return false;
                }
            } catch (Exception e) {
                e.printStackTrace();
                IUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error), -1);
                return false;
            }

        } else {
            LogUtil.d("发送", System.currentTimeMillis());
            if (result.length < rowCount * 0xFA) {
                byte[] temp = new byte[rowCount * 0xFA];
                System.arraycopy(result, 0, temp, 0, result.length);
                result = temp;
            }
            byte[] apdu = new byte[0xFA + 5];
            apdu[0] = (byte) 0xF0;
            apdu[1] = (byte) 0xD2;
            apdu[2] = (byte) ScreenIndex;
            apdu[4] = (byte) 0xFA;
            for (int i = 0; i < rowCount; i++) {
                // 索引号
                apdu[3] = (byte) i;
                for (int j = 0; j < 0xFA; j++) {
                    apdu[5 + j] = (byte) result[i * 0xFA + j];
                }
                try {
                    LogUtil.d(FMUtil.byteToHex(apdu));
                    byte[] datasw = isoDep.transceive(apdu);

                    String strResponse = FMUtil.byteToHex(datasw);
                    if (!strResponse.substring(strResponse.length() - 4).equals("9000")) {
                        IUtils.sendMessage(UIUtils.getString(R.string.hint_error), -1);
                        return false;
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                    IUtils.sendMessage(UIUtils.getString(R.string.hint_error), -1);
                    return false;
                }
            }
        }
        return true;
    }

    private static int sendApdu_back6986_index = 5;

    private static void RefreshScreenAfterWriteBmpdataex(IsoDep isoDep, int ScreenIndex) {
        LogUtil.d("刷屏", System.currentTimeMillis());
        byte[] refreshcmd = new byte[0x5];
        refreshcmd[0] = (byte) 0xF0;
        refreshcmd[1] = (byte) 0xd4;
        refreshcmd[2] = (byte) 0x05;
        refreshcmd[3] = (byte) (ScreenIndex | (byte) 0x80);
        refreshcmd[4] = (byte) 0x00;
        try {
            LogUtil.d(FMUtil.byteToHex(refreshcmd));
            byte[] datasw = isoDep.transceive(refreshcmd);
            String strResponse = FMUtil.byteToHex(datasw);
            LogUtil.d(strResponse);

            if (strResponse.equals("698A")) {
                String strtmp = ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error);
                IUtils.sendMessage(strtmp, -1);
            } else if (strResponse.equals("6986") || "68C6".equals(strResponse)) {
                if (sendApdu_back6986_index > 0) {
                    sendApdu_back6986_index--;
                    //RefreshScreenAfterWriteBmpdataex(isoDep, ScreenIndex);
                    datasw = isoDep.transceive(FMUtil.hexToByte("F0D4850000"));
                    strResponse = FMUtil.byteToHex(datasw);
                    LogUtil.d(strResponse);
                    if (strResponse.equals("009000") || strResponse.equals("9000")) {
                        sendApdu_back6986_index = 5;
                        IUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.text_success), 0);
                    }
                } else {
                    String strtmp = ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.string_res_37);
                    IUtils.sendMessage(strtmp, -1);
                    sendApdu_back6986_index = 5;
                }


            } else if (strResponse.equals("019000")) {
                //有源
                sendApdu_back6986_index = 5;
                IUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.text_success), 0);
            } else if (strResponse.equals("009000") || strResponse.equals("9000")) {
                //无源
                sendApdu_back6986_index = 5;
                GetRefreshResult(isoDep, ScreenIndex);
            } else {
                refreshcmd[3] = (byte) ScreenIndex;
                datasw = isoDep.transceive(refreshcmd);
                strResponse = FMUtil.byteToHex(datasw);
                if (!strResponse.equals("9000")) {
                    // RevEdit.setText("刷屏时发生错误，错误码:" + strResponse);
                    String strtmp = ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.string_res_16);
                    IUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error), -1);
                } else {
                    IUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.text_success), 0);
                }
            }
            LogUtil.d("刷屏", System.currentTimeMillis());
        } catch (IOException e) {
            e.printStackTrace();
            IUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error), -1);
        }

    }


    private static void GetRefreshResult(IsoDep isoDep, int ScreenIndex) {
        byte[] refreshcmd = new byte[0x5];
        refreshcmd[0] = (byte) 0xF0;
        refreshcmd[1] = (byte) 0xd4;
        refreshcmd[2] = (byte) 0x05;
        refreshcmd[3] = (byte) (ScreenIndex | (byte) 0x80);
        refreshcmd[4] = (byte) 0x00;
        String m_strLastErrorMsg = "Error";
        try {
            byte[] datasw = null;
            String strResponse;
            //循环去取刷屏幕的结果
            refreshcmd[1] = (byte) 0xde;
            refreshcmd[2] = (byte) 0x0;
            refreshcmd[3] = (byte) (0x0);
            refreshcmd[4] = (byte) 0x01;


            for (int i = 0; i < 1000; i++) {
                LogUtil.d(FMUtil.byteToHex(refreshcmd));
                datasw = isoDep.transceive(refreshcmd);
                strResponse = FMUtil.byteToHex(datasw);
                Log.d("<-", strResponse);
                if (strResponse.equals("009000")) {
                    IUtils.sendMessage(ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.text_success), 0);
                    LogUtil.d("success", System.currentTimeMillis());
                    return;
                } else if (strResponse.equals("019000")) {
                    Thread.sleep(100); //还需要等待
                } else if (strResponse.equals("698A")) {
                    String strtmp = ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error);
                    m_strLastErrorMsg = strtmp + strResponse;
                    IUtils.sendMessage(m_strLastErrorMsg, -1);
                    return;
                } else if (strResponse.equals("6986") || "68C6".equals(strResponse)) {
                    String strtmp = ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.string_res_37);
                    IUtils.sendMessage(strtmp, -1);
                    return;
                } else {
                    String strtmp = ActivityUtils.instance.getCurrentActivity().getResources().getString(R.string.hint_error);
                    m_strLastErrorMsg = strtmp + strResponse;
                    IUtils.sendMessage(strtmp, -1);
                    return;
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            IUtils.sendMessage(UIUtils.getString(R.string.hint_error), -1);
        }
    }


    /**
     * 获取设备信息
     *
     * @param isoDep
     * @throws IOException
     */
    private static void getDeviceInfo(IsoDep isoDep) throws IOException {

        //获取配置信息
        byte[] result = isoDep.transceive(FMUtil.hexToByte("00D1000000"));
        //检测是否支持pin
        byte[] transceive = isoDep.transceive(FMUtil.hexToByte("F0D8000005000000000E"));
        String toHex = FMUtil.byteToHex(transceive);


        UIUtils.sendMessage(FMUtil.byteToHex(result) + toHex/*.substring(toHex.length())*/, 0, App.getHandler());
    }

    private static void updatePin(IsoDep isodep, String oldPin, String pin) {


        try {
            byte[] appId = FMUtil.hexToByte(App.getDeviceInfo().getAppID());
            byte[] uid = FMUtil.hexToByte(App.getDeviceInfo().getUID());

            for (int i = 0; i < 4; i++) {
                appId[i] = (byte) ~appId[i];
                uid[i] = (byte) ~uid[i];
            }
            String key = FMUtil.byteToHex(uid) + FMUtil.byteToHex(appId);
            LogUtil.d(key);

            //获取随机数
            byte[] randByte = isodep.transceive(new byte[]{0x0, (byte) 0x84, 0x00, 0x00, 0x04});
            byte[] ivRand = new byte[8];
            System.arraycopy(randByte, 0, ivRand, 0, 4);
            String randStr = FMUtil.byteToHex(ivRand);
            LogUtil.d(randStr);
            String command = "80D90101" + String.format("%02x", (oldPin.length() / 2 + pin.length() / 2 + 5)) + oldPin + "FF" + pin;
            String m = command;
            int remainder = m.length() & 16;
            if (remainder == 0) {
                m += "8000000000000000";
            } else {
                m += "80";
                while (m.length() % 16 != 0) {
                    m += "00";
                }
            }
            LogUtil.d(m);
            for (int i = 0; i < m.length() / 16; i++) {
                String cbcDes = EncryUtils.encryptDES(randStr, key, m.substring(i * 16, 16 * (i + 1)));
                randStr = cbcDes;
                LogUtil.d(cbcDes);
            }
            command = command + randStr.substring(0, 8);
            LogUtil.d(command);
            byte[] bytes = isodep.transceive(FMUtil.hexToByte(command));
            String toHex = FMUtil.byteToHex(bytes);
            LogUtil.d(toHex);
            BroadcastManager.getInstance(ActivityUtils.instance.getCurrentActivity()).sendBroadcast("pin", toHex);
        } catch (Exception e) {
            e.printStackTrace();
            BroadcastManager.getInstance(ActivityUtils.instance.getCurrentActivity()).sendBroadcast("pin", e.getMessage());
        }


    }

    private static boolean verifyPinCode(IsoDep isoDep, String pin) throws IOException {
        byte[] transceive = isoDep.transceive(FMUtil.hexToByte(String.format("00200001%02x%s", pin.length() / 2, pin)));
        String result = FMUtil.byteToHex(transceive);
        LogUtil.d(transceive);
        if ("9000".equals(result)) {
            return true;
        } else {
            IUtils.sendMessage(UIUtils.getString(R.string.string_res_5) + "(" + result + ")", -1);
            return false;
        }

    }


}
